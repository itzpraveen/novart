{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>Novart Architecture</title>
    <!-- Google Fonts - optimized weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- Theme initialization (prevents flash) -->
    <script>
        (function() {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>

<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="navbar navbar-expand-md sticky-top mb-4 app-nav nav-elevated">
        <div class="container nav-container">
            <div class="nav-header w-100">
                <a class="navbar-brand d-flex align-items-center" href="{% url 'dashboard' %}">
                    <img src="{% static 'img/novart.png' %}" alt="Novart Architecture" class="brand-logo me-2">
                </a>
                <div class="d-flex align-items-center gap-2">
                    {% if request.user.is_authenticated %}
                    <div class="nav-utility nav-utility-desktop d-none d-md-inline-flex">
                        <div class="dropdown">
                            <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                + New
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                {% if module_perms.leads %}<li><a class="dropdown-item" href="{% url 'lead_create' %}">New Lead</a></li>{% endif %}
                                {% if module_perms.clients %}<li><a class="dropdown-item" href="{% url 'client_list' %}?add=1">New Client</a></li>{% endif %}
                                {% if module_perms.projects %}<li><a class="dropdown-item" href="{% url 'project_create' %}">New Project</a></li>{% endif %}
                                {% if module_perms.invoices %}<li><a class="dropdown-item" href="{% url 'invoice_create' %}">New Invoice</a></li>{% endif %}
                                {% if module_perms.site_visits %}<li><a class="dropdown-item" href="{% url 'site_visit_create' %}">New Site Visit</a></li>{% endif %}
                                <li><a class="dropdown-item" href="{% url 'task_create' %}">New Task</a></li>
                            </ul>
                        </div>
                        <button class="theme-toggle" type="button" aria-label="Toggle dark mode" title="Toggle dark mode">
                            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </button>
                        <a class="nav-link position-relative d-none d-md-inline-flex nav-icon" href="{% url 'notification_list' %}" aria-label="Notifications{% if unread_notifications %} (new){% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" aria-hidden="true">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                            </svg>
                            {% if unread_notifications %}
                            <span
                                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle" aria-hidden="true">
                            </span>
                            <span class="visually-hidden">You have new notifications</span>
                            {% endif %}
                        </a>
                        <div class="dropdown d-none d-md-inline-block">
                            <a class="nav-link dropdown-toggle d-flex align-items-center nav-user-pill" href="#" data-bs-toggle="dropdown">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
                                    style="width: 32px; height: 32px;">
                                    {{ request.user.first_name|first|default:request.user.username|first|upper }}
                                </div>
                                {{ request.user.get_full_name|default:request.user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                <li><a class="dropdown-item" href="{% url 'my_tasks' %}">My Tasks</a></li>
                                <li><a class="dropdown-item" href="{% url 'reminder_settings' %}">Settings</a></li>
                                {% if request.user.role == 'admin' or request.user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'firm_profile' %}">Firm Profile</a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="{% url 'logout' %}" class="px-0 m-0">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger w-100 text-start">Logout</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    <div class="nav-toggle d-flex align-items-center gap-2 d-md-none">
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="collapse navbar-collapse nav-shell" id="navbarNav">
                {% if request.user.is_authenticated %}
                <div class="mobile-user d-md-none d-flex align-items-center justify-content-between py-3 border-bottom">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 36px; height: 36px;">
                            {{ request.user.first_name|first|default:request.user.username|first|upper }}
                        </div>
                        <div>
                            <div class="fw-semibold">{{ request.user.get_full_name|default:request.user.username }}</div>
                            <div class="text-muted small">{{ request.user.role|default:"Member" }}</div>
                        </div>
                    </div>
                    <a class="nav-link position-relative" href="{% url 'notification_list' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                        </svg>
                        {% if unread_notifications %}
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                            <span class="visually-hidden">New alerts</span>
                        </span>
                        {% endif %}
                    </a>
                </div>
                <div class="nav-rail">
                    <div class="nav-pill-track">
                        <div class="nav-pills-scroll">
                            <ul class="navbar-nav mb-0 nav-links flex-row flex-nowrap">
                                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}">Home</a></li>
                                {% if module_perms.clients %}<li class="nav-item"><a class="nav-link {% if 'client' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'client_list' %}">Clients</a></li>{% endif %}
                                {% if module_perms.leads %}<li class="nav-item"><a class="nav-link {% if 'lead' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'lead_list' %}">Leads</a></li>{% endif %}
                                {% if module_perms.projects %}<li class="nav-item"><a class="nav-link {% if 'project' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'project_list' %}">Projects</a></li>{% endif %}
                                {% if module_perms.site_visits %}<li class="nav-item"><a class="nav-link {% if 'site_visit' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'site_visit_list' %}">Site Visits</a></li>{% endif %}
                                {% if module_perms.finance %}<li class="nav-item"><a class="nav-link {% if 'finance' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'finance_dashboard' %}">Finance</a></li>{% endif %}
                                {% if module_perms.invoices %}<li class="nav-item"><a class="nav-link {% if 'invoice' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'invoice_list' %}">Invoices</a></li>{% endif %}
                                {% if module_perms.finance %}<li class="nav-item"><a class="nav-link {% if 'receipt' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'receipt_list' %}">Receipts</a></li>{% endif %}
                                {% if module_perms.docs %}<li class="nav-item"><a class="nav-link {% if 'document' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'document_list' %}">Docs</a></li>{% endif %}
                                {% if module_perms.team %}<li class="nav-item"><a class="nav-link {% if 'team' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'team_list' %}">Team</a></li>{% endif %}
                                {% if module_perms.users %}<li class="nav-item"><a class="nav-link {% if 'user_admin' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'user_admin_list' %}">Users</a></li>{% endif %}
                            </ul>
                        </div>
                    </div>
                    <div class="nav-utility nav-utility-mobile d-flex d-md-none flex-wrap align-items-center gap-2 mt-2">
                        <div class="dropdown">
                            <button class="btn btn-primary btn-sm dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                + New
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                {% if module_perms.leads %}<li><a class="dropdown-item" href="{% url 'lead_create' %}">New Lead</a></li>{% endif %}
                                {% if module_perms.clients %}<li><a class="dropdown-item" href="{% url 'client_list' %}?add=1">New Client</a></li>{% endif %}
                                {% if module_perms.projects %}<li><a class="dropdown-item" href="{% url 'project_create' %}">New Project</a></li>{% endif %}
                                {% if module_perms.invoices %}<li><a class="dropdown-item" href="{% url 'invoice_create' %}">New Invoice</a></li>{% endif %}
                                {% if module_perms.site_visits %}<li><a class="dropdown-item" href="{% url 'site_visit_create' %}">New Site Visit</a></li>{% endif %}
                                <li><a class="dropdown-item" href="{% url 'task_create' %}">New Task</a></li>
                            </ul>
                        </div>
                        <button class="theme-toggle" type="button" aria-label="Toggle dark mode" title="Toggle dark mode">
                            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </button>
                        <a class="nav-link position-relative nav-icon" href="{% url 'notification_list' %}" aria-label="Notifications{% if unread_notifications %} (new){% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" aria-hidden="true">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                            </svg>
                            {% if unread_notifications %}
                            <span
                                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle" aria-hidden="true">
                            </span>
                            <span class="visually-hidden">You have new notifications</span>
                            {% endif %}
                        </a>
                        <div class="dropdown flex-grow-1">
                            <a class="nav-link dropdown-toggle d-flex align-items-center nav-user-pill" href="#" data-bs-toggle="dropdown">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2"
                                    style="width: 32px; height: 32px;">
                                    {{ request.user.first_name|first|default:request.user.username|first|upper }}
                                </div>
                                {{ request.user.get_full_name|default:request.user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0">
                                <li><a class="dropdown-item" href="{% url 'my_tasks' %}">My Tasks</a></li>
                                <li><a class="dropdown-item" href="{% url 'reminder_settings' %}">Settings</a></li>
                                {% if request.user.role == 'admin' or request.user.is_superuser %}
                                <li><a class="dropdown-item" href="{% url 'firm_profile' %}">Firm Profile</a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="{% url 'logout' %}" class="px-0 m-0">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger w-100 text-start">Logout</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <div class="w-100 d-md-none border-top pt-2 mt-1">
                            <a class="nav-link" href="{% url 'my_tasks' %}">My Tasks</a>
                            <a class="nav-link" href="{% url 'reminder_settings' %}">Settings</a>
                            {% if request.user.role == 'admin' or request.user.is_superuser %}
                            <a class="nav-link" href="{% url 'firm_profile' %}">Firm Profile</a>
                            {% endif %}
                            <form method="post" action="{% url 'logout' %}" class="mt-2">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger w-100">Logout</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                {% if request.resolver_match.url_name != 'login' %}
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link btn btn-primary text-white px-4"
                            href="{% url 'login' %}">Login</a></li>
                </ul>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </nav>
    {% block subnav %}{% endblock %}
    <main id="main-content" class="container page-shell mb-5" role="main">
        {% if messages %}
        <div class="messages-container d-none">
            {% for message in messages %}
            <div data-toast-type="{{ message.tags }}" data-toast-message="{{ message }}"></div>
            {% endfor %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    {% if request.user.is_authenticated %}
    <!-- Bottom Navigation Bar (Mobile/Tablet) -->
    <nav class="bottom-nav" aria-label="Mobile navigation">
        <div class="bottom-nav-inner">
            <a href="{% url 'dashboard' %}" class="bottom-nav-item{% if request.resolver_match.url_name == 'dashboard' %} active{% endif %}" aria-label="Dashboard">
                <svg class="bottom-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="bottom-nav-label">Home</span>
            </a>
            {% if module_perms.projects %}
            <a href="{% url 'project_list' %}" class="bottom-nav-item{% if 'project' in request.resolver_match.url_name %} active{% endif %}" aria-label="Projects">
                <svg class="bottom-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="bottom-nav-label">Projects</span>
            </a>
            {% endif %}
            {% if module_perms.clients %}
            <a href="{% url 'client_list' %}" class="bottom-nav-item{% if 'client' in request.resolver_match.url_name %} active{% endif %}" aria-label="Clients">
                <svg class="bottom-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span class="bottom-nav-label">Clients</span>
            </a>
            {% endif %}
            {% if module_perms.invoices %}
            <a href="{% url 'invoice_list' %}" class="bottom-nav-item{% if 'invoice' in request.resolver_match.url_name %} active{% endif %}" aria-label="Invoices">
                <svg class="bottom-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
                <span class="bottom-nav-label">Invoices</span>
            </a>
            {% endif %}
            <div class="bottom-nav-item bottom-nav-more" role="button" tabindex="0" aria-label="More options" aria-expanded="false" aria-haspopup="true">
                <svg class="bottom-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
                <span class="bottom-nav-label">More</span>
                {% if unread_notifications %}<span class="bottom-nav-badge" aria-hidden="true"></span>{% endif %}
                <div class="bottom-nav-menu" role="menu">
                    {% if module_perms.leads %}
                    <a href="{% url 'lead_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                        </svg>
                        Leads
                    </a>
                    {% endif %}
                    {% if module_perms.site_visits %}
                    <a href="{% url 'site_visit_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        Site Visits
                    </a>
                    {% endif %}
                    {% if module_perms.finance %}
                    <a href="{% url 'finance_dashboard' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        Finance
                    </a>
                    <a href="{% url 'receipt_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="3" width="18" height="14" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <path d="M8 17h8"></path>
                        </svg>
                        Receipts
                    </a>
                    {% endif %}
                    {% if module_perms.docs %}
                    <a href="{% url 'document_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        Documents
                    </a>
                    {% endif %}
                    {% if module_perms.team %}
                    <a href="{% url 'team_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Team
                    </a>
                    {% endif %}
                    {% if module_perms.users %}
                    <a href="{% url 'user_admin_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Users
                    </a>
                    {% endif %}
                    <a href="{% url 'notification_list' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        Notifications
                        {% if unread_notifications %}<span class="badge bg-danger ms-auto">New</span>{% endif %}
                    </a>
                    <a href="{% url 'my_tasks' %}" class="bottom-nav-menu-item" role="menuitem">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        My Tasks
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Toast container for notifications -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Toggle
        (function() {
            const toggles = Array.from(document.querySelectorAll('.theme-toggle'));
            if (!toggles.length) return;

            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            function toggleTheme() {
                const current = document.documentElement.getAttribute('data-theme');
                setTheme(current === 'dark' ? 'light' : 'dark');
            }

            toggles.forEach(btn => btn.addEventListener('click', toggleTheme));

            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        })();

        // Bottom Nav More Menu
        (function() {
            const moreBtn = document.querySelector('.bottom-nav-more');
            if (!moreBtn) return;

            function toggleMenu(e) {
                e.stopPropagation();
                const isOpen = moreBtn.classList.toggle('open');
                moreBtn.setAttribute('aria-expanded', isOpen);
            }

            moreBtn.addEventListener('click', toggleMenu);
            moreBtn.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleMenu(e);
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!moreBtn.contains(e.target)) {
                    moreBtn.classList.remove('open');
                    moreBtn.setAttribute('aria-expanded', 'false');
                }
            });
        })();

        // Kanban Column Collapse (mobile)
        (function() {
            if (window.innerWidth > 768) return;

            document.querySelectorAll('.kanban-col .card-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    this.closest('.kanban-col').classList.toggle('collapsed');
                });
            });
        })();

        // Action Dropdown Toggle
        (function() {
            document.querySelectorAll('.action-dropdown-toggle').forEach(function(toggle) {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dropdown = this.closest('.action-dropdown');
                    dropdown.classList.toggle('open');
                });
            });

            document.addEventListener('click', function() {
                document.querySelectorAll('.action-dropdown.open').forEach(function(d) {
                    d.classList.remove('open');
                });
            });
        })();

        // Form loading state on submit
        (function() {
            document.querySelectorAll('form').forEach(function(form) {
                form.addEventListener('submit', function() {
                    const btn = this.querySelector('button[type="submit"]');
                    if (btn && !btn.classList.contains('loading')) {
                        btn.classList.add('loading');
                    }
                });
            });
        })();

        // Toast Notification System
        (function() {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            function createToast(type, message) {
                const toast = document.createElement('div');
                toast.className = 'toast toast-' + (type === 'success' ? 'success' : type === 'error' || type === 'danger' ? 'error' : 'info');
                toast.innerHTML = `
                    <svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' :
                          type === 'error' || type === 'danger' ? '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>' :
                          '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'}
                    </svg>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" aria-label="Close notification">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;

                toast.querySelector('.toast-close').addEventListener('click', function() {
                    toast.style.animation = 'toastExit 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                });

                container.appendChild(toast);

                // Auto-dismiss after 5 seconds
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.style.animation = 'toastExit 0.3s ease forwards';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }

            // Show Django messages as toasts
            document.querySelectorAll('.messages-container [data-toast-message]').forEach(function(el) {
                const type = el.dataset.toastType || 'info';
                const message = el.dataset.toastMessage;
                if (message) {
                    createToast(type, message);
                }
            });

            // Expose for manual use
            window.showToast = createToast;
        })();
    </script>
</body>

</html>
