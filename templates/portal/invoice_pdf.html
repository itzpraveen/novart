{% load portal_extras %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        {% if font_path %}
        @font-face {
            font-family: "DejaVuSans";
            src: url("file://{{ font_path }}");
        }
        {% endif %}
        body { font-family: "DejaVuSans", "Helvetica", "Arial", sans-serif; color: #222; margin: 32px; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #111; padding-bottom: 12px; margin-bottom: 20px; }
        .brand h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px; }
        .brand p { margin: 4px 0 0; font-size: 11px; color: #666; }
        .meta { text-align: right; }
        .meta h2 { margin: 0; font-size: 20px; }
        .meta p { margin: 4px 0; font-size: 12px; }
        .section { margin-bottom: 18px; }
        .section h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: 0.3px; text-transform: uppercase; }
        .box { border: 1px solid #ddd; padding: 10px; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; padding: 8px; background: #f7f7f7; border-bottom: 1px solid #e0e0e0; }
        td { padding: 8px; font-size: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        .totals td { border: none; padding: 4px 8px; font-size: 12px; }
        .totals .label { text-align: right; color: #555; }
        .totals .value { text-align: right; font-weight: bold; }
        .pill { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; color: #0b5ed7; border: 1px solid #0b5ed7; }
        .muted { color: #777; font-size: 11px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">
            {% if firm_logo_data %}
                <img src="{{ firm_logo_data }}" alt="Logo" style="height: 50px; margin-bottom: 6px;">
            {% elif firm_logo_path %}
                <img src="file://{{ firm_logo_path }}" alt="Logo" style="height: 50px; margin-bottom: 6px;">
            {% endif %}
            <h1>{{ firm.name|default:"StudioFlow" }}</h1>
            {% if firm.address %}<p>{{ firm.address }}</p>{% endif %}
            {% if firm.phone %}<p>Phone: {{ firm.phone }}</p>{% endif %}
            {% if firm.email %}<p>Email: {{ firm.email }}</p>{% endif %}
            {% if firm.tax_id %}<p>Tax ID: {{ firm.tax_id }}</p>{% endif %}
        </div>
        <div class="meta">
            <h2>#{{ invoice.invoice_number }}</h2>
            <p>Invoice Date: {{ invoice.invoice_date|date:"d M Y" }}</p>
            <p>Due Date: {{ invoice.due_date|date:"d M Y" }}</p>
            <p>Status: <span class="pill">{{ invoice.get_status_display }}</span></p>
        </div>
    </div>

    <div class="section">
        <h3>Bill To</h3>
        <div class="box">
            <strong>{{ client.name }}</strong><br>
            {% if client.address %}{{ client.address }}<br>{% endif %}
            {% if client.city or client.state %}{{ client.city }} {{ client.state }}<br>{% endif %}
            {% if client.phone %}Phone: {{ client.phone }}<br>{% endif %}
            {% if client.email %}Email: {{ client.email }}{% endif %}
        </div>
    </div>

    <div class="section">
        <h3>Project</h3>
        <div class="box">
            <div><strong>{{ project.code }}</strong> â€” {{ project.name }}</div>
            {% if project.location %}<div class="muted">{{ project.location }}</div>{% endif %}
            {% if project.project_manager %}<div>PM: {{ project.project_manager.get_full_name|default:project.project_manager }}</div>{% endif %}
        </div>
    </div>

    <div class="section">
        <h3>Summary</h3>
        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th style="text-align: right;">Qty</th>
                    <th style="text-align: right;">Rate</th>
                    <th style="text-align: right;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% if lines %}
                    {% for line in lines %}
                    <tr>
                        <td>{{ line.description }}</td>
                        <td style="text-align: right;">{{ line.quantity }}</td>
                        <td style="text-align: right;">{{ line.unit_price|rupee }}</td>
                        <td style="text-align: right;">{{ line.line_total|rupee }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td>{{ invoice.description|default:"Architectural services and deliverables" }}</td>
                        <td style="text-align: right;">1</td>
                        <td style="text-align: right;">{{ invoice.amount|rupee }}</td>
                        <td style="text-align: right;">{{ invoice.amount|rupee }}</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>Totals</h3>
        <table class="totals">
            <tr>
                <td class="label">Subtotal</td>
                <td class="value">{{ invoice.subtotal|rupee }}</td>
            </tr>
            <tr>
                <td class="label">Discount ({{ invoice.discount_percent }}%)</td>
                <td class="value">-{{ invoice.discount_amount|rupee }}</td>
            </tr>
            <tr>
                <td class="label">Tax ({{ invoice.tax_percent }}%)</td>
                <td class="value">{{ tax_amount|rupee }}</td>
            </tr>
            <tr>
                <td class="label">Total</td>
                <td class="value">{{ invoice.total_with_tax|rupee }}</td>
            </tr>
            <tr>
                <td class="label">Payments Received</td>
                <td class="value">{{ invoice.amount_received|rupee }}</td>
            </tr>
            <tr>
                <td class="label">Outstanding</td>
                <td class="value">{{ invoice.outstanding|rupee }}</td>
            </tr>
        </table>
    </div>

    {% if firm.bank_account_number or firm.upi_id %}
    <div class="section">
        <h3>Payment Details</h3>
        <div class="box">
            {% if firm.bank_name %}<div><strong>Bank:</strong> {{ firm.bank_name }}</div>{% endif %}
            {% if firm.bank_account_name %}<div><strong>Account Name:</strong> {{ firm.bank_account_name }}</div>{% endif %}
            {% if firm.bank_account_number %}<div><strong>Account No:</strong> {{ firm.bank_account_number }}</div>{% endif %}
            {% if firm.bank_ifsc %}<div><strong>IFSC:</strong> {{ firm.bank_ifsc }}</div>{% endif %}
            {% if firm.upi_id %}<div><strong>UPI:</strong> {{ firm.upi_id }}</div>{% endif %}
        </div>
    </div>
    {% endif %}

    {% if firm.terms %}
    <div class="section">
        <h3>Payment Terms</h3>
        <div class="box">
            <p class="muted" style="white-space: pre-line;">{{ firm.terms }}</p>
        </div>
    </div>
    {% endif %}

    <div class="section">
        <h3>Payment Activity</h3>
        {% if payments %}
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th style="text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td>{{ payment.payment_date|date:"d M Y" }}</td>
                            <td>{{ payment.method|default:"-" }}</td>
                            <td>{{ payment.reference|default:"-" }}</td>
                            <td style="text-align: right;">{{ payment.amount|rupee }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="muted">No payments recorded against this invoice.</p>
        {% endif %}
    </div>

    <p class="muted">Generated on {{ invoice.updated_at|date:"d M Y H:i" }} via StudioFlow.</p>
</body>
</html>
