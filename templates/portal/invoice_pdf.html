{% load portal_extras %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        {% if font_data %}
        @font-face {
            font-family: "DejaVuSans";
            src: url("data:font/ttf;base64,{{ font_data }}") format("truetype");
        }
        {% elif font_path %}
        @font-face {
            font-family: "DejaVuSans";
            src: url("file://{{ font_path }}");
        }
        {% endif %}
        @page {
            size: A4;
            margin: 26px;
            font-family: "DejaVuSans", "Helvetica", "Arial", sans-serif;
        }
        body, table, th, td {
            font-family: "DejaVuSans", "Helvetica", "Arial", sans-serif;
            color: #111827;
            margin: 0;
            line-height: 1.45;
            font-size: 12px;
        }
        body { background: #f1f5f9; }
        .sheet {
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 18px 20px 16px;
        }
        .muted { color: #6b7280; font-size: 10px; }
        .text-right { text-align: right; }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        .brand-cell { vertical-align: top; width: 60%; }
        .title-cell { vertical-align: top; width: 40%; text-align: right; }
        .invoice-title {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 1.6px;
            margin: 0 0 8px 0;
        }
        .meta-box {
            display: inline-block;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #111827;
            padding: 9px 12px;
            border-radius: 6px;
            font-size: 11px;
            text-align: left;
            min-width: 180px;
        }
        .meta-row { width: 100%; border-collapse: collapse; }
        .meta-row td { padding: 1.5px 0; }
        .meta-label { font-weight: 600; width: 45%; color: #374151; }
        .meta-value { text-align: right; }

        .bill-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        .bill-box {
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 10px;
            border-radius: 6px;
            min-height: 64px;
        }
        .bill-title {
            font-size: 10.5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
            color: #111827;
        }

        .items { width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; }
        .items th {
            background: #111827;
            color: #fff;
            padding: 7px 6px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .items td {
            border-bottom: 1px solid #e5e7eb;
            padding: 7px 6px;
            vertical-align: top;
        }
        .items tbody tr:nth-child(even) { background: #f8fafc; }

        .totals-wrap { width: 100%; margin-top: 10px; }
        .totals-table {
            width: 44%;
            margin-left: 56%;
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .totals-table td {
            padding: 6px 8px;
            font-size: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .totals-table tr:last-child td { border-bottom: none; }
        .totals-label { text-align: right; color: #374151; }
        .totals-value { text-align: right; font-weight: 600; }
        .grand-total-row td {
            background: #111827;
            color: #fff;
            font-weight: 700;
            font-size: 15px;
            padding: 9px 8px;
        }
        .grand-total-row .totals-label { color: #fff; }
        .balance-row td { background: #fff7ed; color: #9a3412; font-weight: 700; }

        .payment-terms { width: 100%; margin-top: 14px; border-collapse: collapse; }
        .payment-col { width: 50%; vertical-align: top; }
        .section-title {
            font-size: 10.5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin: 0 0 4px 0;
        }

        .payment-box {
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 9px 10px;
            border-radius: 6px;
        }

        .hr { border-top: 1px solid #e5e7eb; margin: 16px 0 8px; }
        .footer { font-size: 10px; color: #6b7280; text-align: center; margin-top: 6px; }
    </style>
</head>
<body>
    <div class="sheet">
        <table class="header-table">
            <tr>
                <td class="brand-cell">
                    {% if firm_logo_data %}
                        <img src="{{ firm_logo_data }}" alt="Logo" style="height:48px; margin-bottom:6px;">
                    {% elif firm_logo_path %}
                        <img src="file://{{ firm_logo_path }}" alt="Logo" style="height:48px; margin-bottom:6px;">
                    {% else %}
                        <div style="font-size:18px; font-weight:700;">{{ firm.name|default:"StudioFlow" }}</div>
                    {% endif %}
                    {% if firm.address %}<div class="muted" style="white-space:pre-line;">{{ firm.address }}</div>{% endif %}
                    {% if firm.phone %}<div class="muted">Ph: {{ firm.phone }}</div>{% endif %}
                    {% if firm.email %}<div class="muted">Email: {{ firm.email }}</div>{% endif %}
                    {% if firm.tax_id %}<div class="muted">Tax ID: {{ firm.tax_id }}</div>{% endif %}
                </td>
                <td class="title-cell">
                    <div class="invoice-title">INVOICE</div>
                    <div class="meta-box">
                        <table class="meta-row">
                            <tr><td class="meta-label">Invoice No</td><td class="meta-value">#{{ invoice.invoice_number }}</td></tr>
                            <tr><td class="meta-label">Date</td><td class="meta-value">{{ invoice.invoice_date|date:"d M Y" }}</td></tr>
                            <tr><td class="meta-label">Due Date</td><td class="meta-value">{{ invoice.due_date|date:"d M Y" }}</td></tr>
                            <tr><td class="meta-label">Status</td><td class="meta-value">{{ invoice.get_status_display }}</td></tr>
                        </table>
                    </div>
                </td>
            </tr>
        </table>

        <table class="bill-table">
            <tr>
                <td style="width:50%; padding-right:8px;">
                    <div class="bill-box">
                        <div class="bill-title">Billed To</div>
                        {% if client %}
                            <div style="font-weight:700;">{{ client.name }}</div>
                            {% if client.address %}<div style="white-space:pre-line;">{{ client.address }}</div>{% endif %}
                            {% if client.city or client.state %}<div>{{ client.city }} {{ client.state }}</div>{% endif %}
                            {% if client.phone %}<div class="muted">Phone: {{ client.phone }}</div>{% endif %}
                            {% if client.email %}<div class="muted">Email: {{ client.email }}</div>{% endif %}
                        {% else %}
                            <div class="muted">No client linked</div>
                        {% endif %}
                    </div>
                </td>
                <td style="width:50%; padding-left:8px;">
                    <div class="bill-box">
                        <div class="bill-title">Project / Lead</div>
                        {% if project %}
                            <div style="font-weight:700;">{{ project.code }} — {{ project.name }}</div>
                            {% if project.location %}<div class="muted">{{ project.location }}</div>{% endif %}
                            {% if project.project_manager %}<div class="muted">PM: {{ project.project_manager.get_full_name|default:project.project_manager }}</div>{% endif %}
                        {% elif lead %}
                            <div style="font-weight:700;">{{ lead.title }}</div>
                            <div class="muted">Lead · {{ lead.client.name }}</div>
                        {% else %}
                            <div class="muted">No linked project/lead</div>
                        {% endif %}
                    </div>
                </td>
            </tr>
        </table>

        <table class="items">
            <thead>
                <tr>
                    <th style="width:55%;">Item Description</th>
                    <th style="width:15%;" class="text-right">Qty</th>
                    <th style="width:15%;" class="text-right">Unit Price</th>
                    <th style="width:15%;" class="text-right">Total</th>
                </tr>
            </thead>
            <tbody>
                {% if lines %}
                    {% for line in lines %}
                    <tr>
                        <td>{{ line.description }}</td>
                        <td class="text-right">{{ line.quantity }}</td>
                        <td class="text-right">{{ line.unit_price|rupee }}</td>
                        <td class="text-right">{{ line.line_total|rupee }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td>{{ invoice.description|default:"Architectural services and deliverables" }}</td>
                        <td class="text-right">1</td>
                        <td class="text-right">{{ invoice.amount|rupee }}</td>
                        <td class="text-right">{{ invoice.amount|rupee }}</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>

        <div class="totals-wrap">
            <table class="totals-table">
                <tr>
                    <td class="totals-label">Sub Total</td>
                    <td class="totals-value">{{ invoice.subtotal|rupee }}</td>
                </tr>
                {% if invoice.discount_percent %}
                <tr>
                    <td class="totals-label">Discount ({{ invoice.discount_percent }}%)</td>
                    <td class="totals-value">-{{ invoice.discount_amount|rupee }}</td>
                </tr>
                {% endif %}
                {% if invoice.tax_percent %}
                <tr>
                    <td class="totals-label">Tax ({{ invoice.tax_percent }}%)</td>
                    <td class="totals-value">{{ tax_amount|rupee }}</td>
                </tr>
                {% endif %}
                <tr class="grand-total-row">
                    <td class="totals-label">Net Total</td>
                    <td class="totals-value">{{ invoice.total_with_tax|rupee }}</td>
                </tr>
                {% if invoice.amount_received %}
                <tr>
                    <td class="totals-label">Advance / Received</td>
                    <td class="totals-value">-{{ invoice.amount_received|rupee }}</td>
                </tr>
                {% endif %}
                <tr{% if invoice.amount_received %} class="balance-row"{% endif %}>
                    <td class="totals-label">Outstanding</td>
                    <td class="totals-value">{{ invoice.outstanding|rupee }}</td>
                </tr>
            </table>
        </div>

        {% if firm.bank_account_number or firm.upi_id or firm.terms %}
        <table class="payment-terms">
            <tr>
                <td class="payment-col" style="padding-right:10px;">
                    <div class="payment-box">
                        <div class="section-title">Payment Method</div>
                        {% if firm.bank_name %}<div class="muted"><strong>Bank:</strong> {{ firm.bank_name }}</div>{% endif %}
                        {% if firm.bank_account_name %}<div class="muted"><strong>A/C Name:</strong> {{ firm.bank_account_name }}</div>{% endif %}
                        {% if firm.bank_account_number %}<div class="muted"><strong>A/C No:</strong> {{ firm.bank_account_number }}</div>{% endif %}
                        {% if firm.bank_ifsc %}<div class="muted"><strong>IFSC:</strong> {{ firm.bank_ifsc }}</div>{% endif %}
                        {% if firm.upi_id %}<div class="muted"><strong>UPI:</strong> {{ firm.upi_id }}</div>{% endif %}
                    </div>
                </td>
                <td class="payment-col" style="padding-left:10px;">
                    {% if firm.terms %}
                        <div class="payment-box">
                            <div class="section-title">Terms</div>
                            <div class="muted" style="white-space:pre-line;">{{ firm.terms }}</div>
                        </div>
                    {% endif %}
                </td>
            </tr>
        </table>
        {% endif %}

        {% if payments %}
        <div style="margin-top:12px;">
            <div class="section-title">Payment Activity</div>
            <table class="items" style="margin-top:4px;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th class="text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.payment_date|date:"d M Y" }}</td>
                        <td>{{ payment.method|default:"-" }}</td>
                        <td>{{ payment.reference|default:"-" }}</td>
                        <td class="text-right">{{ payment.amount|rupee }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="hr"></div>
        <div style="font-size:11px; font-weight:700;">Thank you for your business</div>
        <div class="footer">
            Generated on {{ generated_on|date:"d M Y H:i" }}{% if firm.email %} · {{ firm.email }}{% endif %}
        </div>
    </div>
</body>
</html>
