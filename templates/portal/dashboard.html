{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">Dashboard</h2>
        <p class="text-muted">Welcome back, here's what's happening today.</p>
    </div>
    <a href="{% url 'project_create' %}" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New Project
    </a>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <a href="{% url 'project_list' %}" class="card h-100 border-0 shadow-sm text-decoration-none text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-primary">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z">
                            </path>
                        </svg>
                    </div>
                    <span class="stat-label mb-0">Total Projects</span>
                </div>
                <h3 class="stat-value">{{ total_projects }}</h3>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'project_list' %}?active=1" class="card h-100 border-0 shadow-sm text-decoration-none text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success bg-opacity-10 p-2 rounded-circle me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-success">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <span class="stat-label mb-0">Active</span>
                </div>
                <h3 class="stat-value">{{ active_projects }}</h3>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{% url 'site_visit_list' %}" class="card h-100 border-0 shadow-sm text-decoration-none text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning bg-opacity-10 p-2 rounded-circle me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-warning">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <span class="stat-label mb-0">Site Visits</span>
                </div>
                <h3 class="stat-value">{{ site_visits_this_month }}</h3>
                <small class="text-muted">This Month</small>
            </div>
        </a>
    </div>
    {% if show_finance %}
    <div class="col-md-3">
        <a href="{% url 'invoice_list' %}?status=unpaid" class="card h-100 border-0 shadow-sm text-decoration-none text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-danger">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                    </div>
                    <span class="stat-label mb-0">Outstanding</span>
                </div>
                <h3 class="stat-value">{{ cash_gap_rupee }}</h3>
                <small class="text-muted">This Month</small>
            </div>
        </a>
    </div>
    {% else %}
    <div class="col-md-3">
        <a href="{% url 'my_tasks' %}" class="card h-100 border-0 shadow-sm text-decoration-none text-dark">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-danger">
                            <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                            <path d="M8 9h8M8 13h5"></path>
                        </svg>
                    </div>
                    <span class="stat-label mb-0">My Open Tasks</span>
                </div>
                <h3 class="stat-value">{{ my_open_tasks_count }}</h3>
            </div>
        </a>
    </div>
    {% endif %}
</div>

<div class="row g-4">
    <!-- Projects by Stage -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Projects by Stage</span>
                <a href="{% url 'project_list' %}" class="text-decoration-none small">View All</a>
            </div>
            <ul class="list-group list-group-flush">
                {% for item in stage_counts %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="text-secondary">{{ item.current_stage }}</span>
                    <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                </li>
                {% empty %}
                <li class="list-group-item text-center py-4">
                    <div class="text-muted mb-2">No projects yet</div>
                    <a href="{% url 'project_create' %}" class="btn btn-sm btn-primary">Create Project</a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Upcoming Tasks -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Upcoming Tasks</span>
                <a href="{% url 'my_tasks' %}" class="text-decoration-none small">View All</a>
            </div>
            <div class="list-group list-group-flush">
                {% for task in upcoming_tasks %}
                <a class="list-group-item list-group-item-action border-0 border-bottom"
                    href="{% url 'project_tasks' task.project.pk %}">
                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-truncate" style="max-width: 70%;">{{ task.title }}</h6>
                        <small class="text-danger fw-medium">{{ task.due_date|date:"d M" }}</small>
                    </div>
                    <small class="text-muted">{{ task.project.code }}</small>
                </a>
                {% empty %}
                <div class="list-group-item text-center py-4">
                    <div class="text-muted mb-2">No pending tasks</div>
                    <a href="{% url 'task_create' %}" class="btn btn-sm btn-primary">Add Task</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Upcoming Handovers -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Upcoming Handovers</div>
            <div class="list-group list-group-flush">
                {% for project in upcoming_handover %}
                <div class="list-group-item border-0 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ project.name }}</h6>
                            <small class="text-muted">{{ project.code }}</small>
                        </div>
                        <span class="badge bg-info text-dark">{{ project.expected_handover|date:"d M" }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="list-group-item text-center py-4">
                    <div class="text-muted">No upcoming handovers</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% if show_finance %}
<div class="row g-4 mt-1">
    <!-- Financial Snapshot -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">Financial Snapshot <small class="text-muted fw-normal">(This Month)</small></div>
            <div class="card-body">
                <div class="row text-center g-3">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded-3">
                            <p class="text-muted small mb-1">Invoiced</p>
                            <h4 class="mb-0 text-primary">{{ total_invoiced_month|rupee }}</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded-3">
                            <p class="text-muted small mb-1">Received</p>
                            <h4 class="mb-0 text-success">{{ total_received_month|rupee }}</h4>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Cash Gap</span>
                        <span class="fw-bold {% if cash_gap > 0 %}text-danger{% else %}text-success{% endif %}">{{ cash_gap_rupee }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Projects -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">Top Projects by Revenue</div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Project</th>
                            <th>Client</th>
                            <th class="text-end">Invoiced</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in top_projects %}
                        <tr>
                            <td>
                                <a href="{% url 'project_detail' project.pk %}"
                                    class="fw-medium text-decoration-none">{{ project.code }}</a>
                            </td>
                            <td>{{ project.client.name }}</td>
                            <td class="text-end fw-bold">{{ project.revenue|rupee }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <div class="text-muted mb-2">No invoices yet</div>
                                <a href="{% url 'invoice_create' %}" class="btn btn-sm btn-primary">Create Invoice</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
