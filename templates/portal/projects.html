{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="page-header page-header-sticky">
    <h2 class="mb-0">Projects</h2>
    <div class="actions">
        <a class="btn btn-primary" href="{% url 'project_create' %}">New Project</a>
    </div>
</div>

<div class="summary-grid">
    <div class="stat-tile">
        <div class="label">Total projects</div>
        <div class="value">{{ project_summary.total }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">Active</div>
        <div class="value">{{ project_summary.active }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">At risk</div>
        <div class="value text-warning">{{ project_summary.at_risk }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">Delayed</div>
        <div class="value text-danger">{{ project_summary.delayed }}</div>
    </div>
</div>

<button class="btn btn-outline-secondary w-100 d-lg-none filter-toggle mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#projectFilters" aria-expanded="false" aria-controls="projectFilters">
    Filters
</button>
<div class="card shadow-sm mb-3 collapse show d-lg-block" id="projectFilters">
    <div class="card-body">
        <form method="get" class="row g-3">
            {% for field in filter.form %}
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">{{ field.label }}</label>
                    {{ field|add_class:"form-select" }}
                </div>
            {% endfor %}
            <div class="col-12 col-md-3 col-lg-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" type="submit">Filter</button>
            </div>
        </form>
    </div>
</div>

<div class="filter-bar">
    <form class="d-flex align-items-center gap-2 flex-grow-1" onsubmit="return false;">
        <input id="projectSearch" type="search" class="form-control" placeholder="Live search by code, client, manager" aria-label="Search projects">
    </form>
    <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-2 flex-wrap" aria-label="Health quick filters">
            <button class="chip chip-ghost" type="button" data-health-filter="all">All</button>
            <button class="chip chip-soft text-success border-0" type="button" data-health-filter="on_track">On track</button>
            <button class="chip chip-soft text-warning border-0" type="button" data-health-filter="at_risk">At risk</button>
            <button class="chip chip-soft text-danger border-0" type="button" data-health-filter="delayed">Delayed</button>
        </div>
        <div class="text-muted small" id="projectCount" aria-live="polite">Showing {{ filter.qs|length }}</div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table mb-0 align-middle table-stack">
            <thead>
            <tr>
                <th>Code</th>
                <th>Client</th>
                <th>Manager</th>
                <th>Site Engineer</th>
                <th>Stage</th>
                <th>Health</th>
                <th>Start</th>
                <th>Handover</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for project in filter.qs %}
                <tr class="project-row" data-search="{{ project.code }} {{ project.client.name }} {{ project.project_manager }} {{ project.site_engineer }} {{ project.current_stage }} {{ project.get_health_status_display }}" data-health="{{ project.health_status|default:'unknown' }}">
                    <td data-label="Code"><a href="{% url 'project_detail' project.pk %}" class="fw-semibold">{{ project.code }}</a></td>
                    <td data-label="Client">{{ project.client.name }}</td>
                    <td data-label="Manager">{{ project.project_manager|default:"—" }}</td>
                    <td data-label="Site Engineer">{{ project.site_engineer|default:"—" }}</td>
                    <td data-label="Stage"><span class="chip chip-ghost">{{ project.current_stage }}</span></td>
                    <td data-label="Health"><span class="badge bg-{% if project.health_status == 'delayed' %}danger{% elif project.health_status == 'at_risk' %}warning{% else %}success{% endif %}">
                        {{ project.get_health_status_display }}
                    </span></td>
                    <td data-label="Start">{{ project.start_date|date:"d-m-Y" }}</td>
                    <td data-label="Handover">{{ project.expected_handover|date:"d-m-Y" }}</td>
                    <td data-label="Actions" class="text-end">
                        <div class="stack-inline justify-content-end">
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'project_edit' project.pk %}">Edit</a>
                            <a class="btn btn-sm btn-outline-primary" href="{% url 'project_tasks' project.pk %}">Kanban</a>
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" class="text-center">No projects found.</td></tr>
            {% endfor %}
            <tr id="projectEmptyState" class="d-none"><td colspan="9" class="text-center text-muted py-4">No matches for this search.</td></tr>
            </tbody>
        </table>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('projectSearch');
    const rows = Array.from(document.querySelectorAll('.project-row'));
    const empty = document.getElementById('projectEmptyState');
    const counter = document.getElementById('projectCount');
    const chips = Array.from(document.querySelectorAll('[data-health-filter]'));

    const filterRows = (term, health) => {
        const q = term.trim().toLowerCase();
        const healthKey = health || 'all';
        let visible = 0;
        rows.forEach(row => {
            const txt = row.dataset.search.toLowerCase();
            const healthVal = row.dataset.health || 'unknown';
            const matchesText = !q || txt.includes(q);
            const matchesHealth = healthKey === 'all' || healthVal === healthKey;
            const show = matchesText && matchesHealth;
            row.style.display = show ? '' : 'none';
            if (show) visible += 1;
        });
        if (empty) empty.classList.toggle('d-none', visible !== 0);
        if (counter) counter.textContent = `Showing ${visible}`;
    };

    let currentHealth = 'all';
    chips.forEach(chip => {
        chip.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentHealth = chip.dataset.healthFilter;
            filterRows(input ? input.value : '', currentHealth);
        });
    });

    if (input) {
        input.addEventListener('input', () => filterRows(input.value, currentHealth));
    }
    filterRows(input ? input.value : '', currentHealth);
});
</script>
{% endblock %}
