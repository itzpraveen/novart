{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="page-header page-header-sticky">
    <h2 class="mb-0">Projects</h2>
    <div class="actions">
        <a class="btn btn-outline-secondary" href="{% url 'export_projects_csv' %}">Export CSV</a>
        <a class="btn btn-primary" href="{% url 'project_create' %}">New Project</a>
    </div>
</div>

<div class="summary-grid">
    <div class="stat-tile">
        <div class="label">Total projects</div>
        <div class="value">{{ project_summary.total }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">Active</div>
        <div class="value">{{ project_summary.active }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">At risk</div>
        <div class="value text-warning">{{ project_summary.at_risk }}</div>
    </div>
    <div class="stat-tile">
        <div class="label">Delayed</div>
        <div class="value text-danger">{{ project_summary.delayed }}</div>
    </div>
</div>

<div class="filter-bar">
    <form class="d-flex align-items-center gap-2 flex-grow-1 flex-wrap" method="get">
        <input id="projectSearch" type="search" class="form-control" style="max-width: 280px;" placeholder="Live search by code, client, manager" aria-label="Search projects">
        {% if filter.form.ordering %}
            <div class="d-flex d-md-none align-items-center gap-2">
                <label class="form-label text-muted small mb-0" for="{{ filter.form.ordering.id_for_label }}">Sort</label>
                {{ filter.form.ordering|add_class:"form-select form-select-sm" }}
            </div>
        {% endif %}
        <details class="filter-details">
            <summary class="btn btn-outline-secondary btn-sm">More filters</summary>
            <div class="filter-dropdown">
                {% for field in filter.form %}
                    {% if field.name != "ordering" %}
                        <div class="filter-field">
                            <label class="form-label text-muted small mb-1" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field|add_class:"form-select form-select-sm" }}
                        </div>
                    {% endif %}
                {% endfor %}
                <button class="btn btn-primary btn-sm w-100 mt-2" type="submit">Apply</button>
            </div>
        </details>
    </form>
    <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-2 flex-wrap" aria-label="Health quick filters">
            <button class="chip chip-ghost" type="button" data-health-filter="all">All</button>
            <button class="chip chip-soft text-success border-0" type="button" data-health-filter="on_track">On track</button>
            <button class="chip chip-soft text-warning border-0" type="button" data-health-filter="at_risk">At risk</button>
            <button class="chip chip-soft text-danger border-0" type="button" data-health-filter="delayed">Delayed</button>
        </div>
        <div class="text-muted small" id="projectCount" aria-live="polite">Showing {{ filter.qs|length }}</div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table mb-0 align-middle table-stack">
            <thead>
            <tr>
                <th><a class="table-sort" href="{% sort_url request 'code' %}">Code{% sort_indicator request 'code' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'client' %}">Client{% sort_indicator request 'client' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'manager' %}">Manager{% sort_indicator request 'manager' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'site_engineer' %}">Site Engineer{% sort_indicator request 'site_engineer' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'stage' %}">Stage{% sort_indicator request 'stage' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'health' %}">Health{% sort_indicator request 'health' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'start_date' %}">Start{% sort_indicator request 'start_date' %}</a></th>
                <th><a class="table-sort" href="{% sort_url request 'expected_handover' %}">Handover{% sort_indicator request 'expected_handover' %}</a></th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for project in filter.qs %}
                <tr class="project-row" data-search="{{ project.code }} {{ project.client.name }} {{ project.project_manager }} {{ project.site_engineer }} {{ project.current_stage }} {{ project.get_health_status_display }}" data-health="{{ project.health_status|default:'unknown' }}">
                    <td data-label="Code"><a href="{% url 'project_detail' project.pk %}" class="fw-semibold">{{ project.code }}</a></td>
                    <td data-label="Client">{{ project.client.name }}</td>
                    <td data-label="Manager">{{ project.project_manager|default:"—" }}</td>
                    <td data-label="Site Engineer">{{ project.site_engineer|default:"—" }}</td>
                    <td data-label="Stage"><span class="chip chip-ghost">{{ project.current_stage }}</span></td>
                    <td data-label="Health"><span class="badge bg-{% if project.health_status == 'delayed' %}danger{% elif project.health_status == 'at_risk' %}warning{% else %}success{% endif %}">
                        {{ project.get_health_status_display }}
                    </span></td>
                    <td data-label="Start">{{ project.start_date|date:"d M Y" }}</td>
                    <td data-label="Handover">{{ project.expected_handover|date:"d M Y" }}</td>
                    <td data-label="Actions" class="text-end">
                        <div class="stack-inline justify-content-end">
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'project_edit' project.pk %}">Edit</a>
                            <a class="btn btn-sm btn-outline-primary" href="{% url 'project_tasks' project.pk %}">Kanban</a>
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" class="text-center">No projects found.</td></tr>
            {% endfor %}
            <tr id="projectEmptyState" class="d-none"><td colspan="9" class="text-center text-muted py-4">No matches for this search.</td></tr>
            </tbody>
        </table>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('projectSearch');
    const rows = Array.from(document.querySelectorAll('.project-row'));
    const empty = document.getElementById('projectEmptyState');
    const counter = document.getElementById('projectCount');
    const chips = Array.from(document.querySelectorAll('[data-health-filter]'));
    const sortSelect = document.querySelector('select[name="ordering"]');

    const filterRows = (term, health) => {
        const q = term.trim().toLowerCase();
        const healthKey = health || 'all';
        let visible = 0;
        rows.forEach(row => {
            const txt = row.dataset.search.toLowerCase();
            const healthVal = row.dataset.health || 'unknown';
            const matchesText = !q || txt.includes(q);
            const matchesHealth = healthKey === 'all' || healthVal === healthKey;
            const show = matchesText && matchesHealth;
            row.style.display = show ? '' : 'none';
            if (show) visible += 1;
        });
        if (empty) empty.classList.toggle('d-none', visible !== 0);
        if (counter) counter.textContent = `Showing ${visible}`;
    };

    let currentHealth = 'all';
    chips.forEach(chip => {
        chip.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentHealth = chip.dataset.healthFilter;
            filterRows(input ? input.value : '', currentHealth);
        });
    });

    if (input) {
        input.addEventListener('input', () => filterRows(input.value, currentHealth));
    }
    if (sortSelect && sortSelect.form) {
        sortSelect.addEventListener('change', () => sortSelect.form.submit());
    }
    filterRows(input ? input.value : '', currentHealth);
});
</script>
{% endblock %}
