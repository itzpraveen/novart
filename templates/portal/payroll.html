{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="page-header">
    <div>
        <div class="eyebrow">Finance</div>
        <h2 class="mb-0">Payroll</h2>
    </div>
    <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'finance_dashboard' %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            Finance
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'transaction_list' %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/></svg>
            Cashbook
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'export_payroll_csv' %}?month={{ month_str }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export
        </a>
        <button class="btn btn-primary btn-sm d-md-none" data-bs-toggle="offcanvas" data-bs-target="#salaryOffcanvas" aria-controls="salaryOffcanvas">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Pay Salary
        </button>
    </div>
</div>

<div class="d-md-flex gap-4 align-items-start">
    <div class="flex-grow-1">
        {# Month Filter #}
        <div class="card mb-4">
            <div class="card-body py-3">
                <form method="get" class="d-flex flex-wrap gap-3 align-items-end">
                    <div class="flex-grow-1" style="min-width: 200px; max-width: 280px;">
                        <label class="form-label text-muted small mb-1" for="month">Select Month</label>
                        <input type="month" class="form-control" id="month" name="month" value="{{ month_str }}">
                    </div>
                    <button class="btn btn-outline-primary" type="submit">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
                        Apply
                    </button>
                </form>
            </div>
        </div>

        {# Stats Cards #}
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="rounded-circle p-2" style="background: var(--primary-subtle);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
                            </div>
                            <span class="text-muted small">Planned</span>
                        </div>
                        <div class="h4 mb-0 fw-bold">{{ totals.salary|rupee }}</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="rounded-circle p-2" style="background: var(--success-light);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                            <span class="text-muted small">Paid</span>
                        </div>
                        <div class="h4 mb-0 fw-bold text-success">{{ totals.paid|rupee }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card h-100 {% if totals.due > 0 %}border-warning{% endif %}">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="rounded-circle p-2" style="background: {% if totals.due > 0 %}var(--warning-light){% else %}var(--bg-subtle){% endif %};">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="{% if totals.due > 0 %}var(--warning-color){% else %}var(--text-muted){% endif %}" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <span class="text-muted small">Due</span>
                        </div>
                        <div class="h4 mb-0 fw-bold {% if totals.due > 0 %}text-warning{% endif %}">{{ totals.due|rupee }}</div>
                    </div>
                </div>
            </div>
        </div>

        {# Employee Salary Table #}
        <div class="card mb-4">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-semibold">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-muted"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                    Employees
                </h6>
                <span class="badge bg-secondary-subtle text-secondary">{{ staff_rows|length }} staff</span>
            </div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle table-stack">
                    <thead class="table-light">
                    <tr>
                        <th>Employee</th>
                        <th class="text-end">Monthly Salary</th>
                        <th class="text-end">Paid</th>
                        <th class="text-end">Due</th>
                        <th class="text-end" style="width: 100px;">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in staff_rows %}
                        <tr>
                            <td data-label="Employee">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="avatar-circle" style="width: 36px; height: 36px; background: var(--primary-subtle); color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;">
                                        {{ row.staff.get_full_name|default:row.staff.username|slice:":1"|upper }}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ row.staff.get_full_name|default:row.staff.username }}</div>
                                        <small class="text-muted">{{ row.staff.get_role_display }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end" data-label="Monthly Salary">{{ row.salary|rupee }}</td>
                            <td class="text-end text-success" data-label="Paid">{{ row.paid|rupee }}</td>
                            <td class="text-end fw-semibold {% if row.due > 0 %}text-warning{% else %}text-success{% endif %}" data-label="Due">{{ row.due|rupee }}</td>
                            <td class="text-end" data-label="Action">
                                {% if row.due > 0 %}
                                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="offcanvas" data-bs-target="#salaryOffcanvas" aria-controls="salaryOffcanvas" data-person="{{ row.staff.pk }}" data-amount="{{ row.due }}">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-1"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/></svg>
                                        Pay
                                    </button>
                                {% else %}
                                    <span class="badge bg-success-subtle text-success">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="me-1"><polyline points="20 6 9 17 4 12"/></svg>
                                        Paid
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        {% url 'user_admin_list' as user_admin_url %}
                        {% include "includes/empty_state.html" with colspan=5 icon="users" title="No employees configured" description="Add salary information to user profiles to track payroll." cta_url=user_admin_url cta_label="Manage Users" cta_class="btn btn-sm btn-outline-primary" compact=True %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Salary Payments History #}
        <div class="card">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-semibold">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-muted"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Payments · {{ month_start|date:"F Y" }}
                </h6>
                <span class="badge bg-secondary-subtle text-secondary">{{ salary_txns|length }} payment{{ salary_txns|length|pluralize }}</span>
            </div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle table-stack">
                    <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Account</th>
                        <th class="text-end">Amount</th>
                        <th class="hide-tablet">Recorded by</th>
                        <th class="hide-tablet">Remarks</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for txn in salary_txns %}
                        <tr>
                            <td data-label="Date">
                                <span class="fw-medium">{{ txn.date|date:"d" }}</span>
                                <span class="text-muted">{{ txn.date|date:"M Y" }}</span>
                            </td>
                            <td data-label="Employee">
                                <span class="fw-medium">{{ txn.related_person }}</span>
                            </td>
                            <td data-label="Account">
                                {% if txn.account %}
                                <span class="badge bg-secondary-subtle text-secondary">{{ txn.account.name }}</span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-semibold text-success" data-label="Amount">{{ txn.debit|rupee }}</td>
                            <td class="hide-tablet" data-label="Recorded by">
                                <span class="text-muted">{{ txn.recorded_by|default:"—" }}</span>
                            </td>
                            <td class="hide-tablet" data-label="Remarks">
                                {% if txn.remarks %}
                                <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ txn.remarks }}">{{ txn.remarks }}</span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        {% include "includes/empty_state.html" with colspan=6 icon="calendar" title="No payments this month" description="Salary payments will appear here when recorded." compact=True %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# Salary Payment Form - Offcanvas on mobile, sticky sidebar on desktop #}
    <div class="offcanvas-md offcanvas-end" tabindex="-1" id="salaryOffcanvas" aria-labelledby="salaryOffcanvasLabel" data-bs-scroll="true" style="--bs-offcanvas-width: 380px;">
        <div class="offcanvas-header border-bottom d-md-none">
            <h5 class="offcanvas-title" id="salaryOffcanvasLabel">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/><circle cx="16" cy="14" r="2"/></svg>
                Record Payment
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
            <div class="card border-0 shadow-none rounded-0 rounded-md-3 h-100">
                <div class="card-header bg-transparent border-bottom d-none d-md-block">
                    <h6 class="mb-0 fw-semibold">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2 text-primary"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/><circle cx="16" cy="14" r="2"/></svg>
                        Record Payment
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label class="form-label text-muted small" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {% if field.name == 'related_person' or field.name == 'account' %}
                                    {{ field|add_class:"form-select" }}
                                {% else %}
                                    {{ field|add_class:"form-control" }}
                                {% endif %}
                                {% for error in field.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                            </div>
                        {% endfor %}
                        <button class="btn btn-primary w-100 mt-2">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-2"><polyline points="20 6 9 17 4 12"/></svg>
                            Save Payment
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
    const offcanvas = document.getElementById('salaryOffcanvas');
    if (!offcanvas) return;
    offcanvas.addEventListener('show.bs.offcanvas', (event) => {
        const trigger = event.relatedTarget;
        if (!trigger) return;
        const personId = trigger.getAttribute('data-person');
        const amount = trigger.getAttribute('data-amount');
        const personField = offcanvas.querySelector('select[name="related_person"]');
        const amountField = offcanvas.querySelector('input[name="debit"]');
        if (personField && personId) personField.value = personId;
        if (amountField && amount) amountField.value = amount;
    });
})();
</script>
{% endblock %}
