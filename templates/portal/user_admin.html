{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="page-header page-header-sticky">
    <div>
        <div class="eyebrow text-uppercase">Settings</div>
        <h2 class="mb-0">Users & Permissions</h2>
        <div class="text-muted small">Manage team accounts and role-based access control.</div>
    </div>
    <div class="actions">
        {% if editing %}
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'user_admin_list' %}">+ New User</a>
        {% endif %}
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-pills nav-fill mb-4 user-admin-tabs" id="userAdminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="pill" data-bs-target="#users-panel" type="button" role="tab" aria-controls="users-panel" aria-selected="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span class="d-none d-sm-inline">Team Members</span>
            <span class="d-sm-none">Team</span>
            <span class="badge bg-primary-subtle text-primary ms-2">{{ users|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="form-tab" data-bs-toggle="pill" data-bs-target="#form-panel" type="button" role="tab" aria-controls="form-panel" aria-selected="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
            <span class="d-none d-sm-inline">{% if editing %}Edit User{% else %}Add User{% endif %}</span>
            <span class="d-sm-none">{% if editing %}Edit{% else %}Add{% endif %}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="permissions-tab" data-bs-toggle="pill" data-bs-target="#permissions-panel" type="button" role="tab" aria-controls="permissions-panel" aria-selected="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <span class="d-none d-sm-inline">Role Permissions</span>
            <span class="d-sm-none">Roles</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="userAdminTabContent">
    <!-- Team Members Panel -->
    <div class="tab-pane fade show active" id="users-panel" role="tabpanel" aria-labelledby="users-tab">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <div class="fw-semibold">Team Directory</div>
                <div class="d-flex align-items-center gap-2">
                    <input type="search" id="userSearch" class="form-control form-control-sm" style="max-width: 200px;" placeholder="Search usersâ€¦" aria-label="Search users">
                </div>
            </div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle table-stack" id="usersTable">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                        <tr data-search="{{ user.get_full_name|default:user.username }} {{ user.username }} {{ user.get_role_display }}">
                            <td data-label="Name">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; font-weight: 600;">
                                        {{ user.first_name|first|default:user.username|first|upper }}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ user.get_full_name|default:user.username }}</div>
                                        {% if user.email %}<small class="text-muted">{{ user.email }}</small>{% endif %}
                                    </div>
                                </div>
                            </td>
                            <td data-label="Username"><code class="text-muted">{{ user.username }}</code></td>
                            <td data-label="Role">
                                <span class="chip chip-soft">{{ user.get_role_display }}</span>
                            </td>
                            <td data-label="Status">
                                {% if user.is_active %}
                                    <span class="badge bg-success-subtle text-success">Active</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td data-label="Actions" class="text-end">
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'user_admin_edit' user.pk %}">Edit</a>
                            </td>
                        </tr>
                    {% empty %}
                        {% include "includes/empty_state.html" with colspan=5 title="No users yet" description="Create user accounts to manage team access." compact=True %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Panel -->
    <div class="tab-pane fade" id="form-panel" role="tabpanel" aria-labelledby="form-tab">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="fw-semibold">{% if editing %}Edit {{ editing.get_full_name|default:editing.username }}{% else %}Create New User{% endif %}</div>
                        <small class="text-muted">{% if editing %}Update account details and role.{% else %}Add a new team member to your organization.{% endif %}</small>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            <div class="row g-3">
                                {% for field in form %}
                                <div class="col-md-{% if field.name == 'username' or field.name == 'role' %}6{% else %}12{% endif %}">
                                    {% if field.field.widget.input_type == "checkbox" %}
                                        <div class="form-check form-switch py-2">
                                            {{ field|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                        </div>
                                    {% else %}
                                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field|add_class:"form-control" }}
                                        {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                    {% endif %}
                                    {% for error in field.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-primary flex-grow-1">{% if editing %}Save Changes{% else %}Create User{% endif %}</button>
                                <a class="btn btn-outline-secondary" href="{% url 'user_admin_list' %}">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>

                {% if editing_perms %}
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">Current Access</div>
                        <span class="chip chip-soft">{{ editing.get_role_display }}</span>
                    </div>
                    <div class="card-body">
                        <div class="text-muted small mb-3">Modules this user can access based on their role:</div>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            {% for key,label in editing_perms.allowed %}
                                <span class="badge bg-success-subtle text-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    {{ label }}
                                </span>
                            {% empty %}
                                <span class="text-muted small">No modules enabled for this role.</span>
                            {% endfor %}
                        </div>
                        {% if editing_perms.blocked %}
                            <div class="mt-3 pt-3 border-top">
                                <div class="text-muted small mb-2">Hidden modules:</div>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for key,label in editing_perms.blocked %}
                                        <span class="badge bg-light text-muted">{{ label }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Role Permissions Panel -->
    <div class="tab-pane fade" id="permissions-panel" role="tabpanel" aria-labelledby="permissions-tab">
        <div class="alert alert-info small mb-4">
            <div class="d-flex align-items-start gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 mt-1">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <div>
                    <div class="fw-semibold mb-1">How role permissions work</div>
                    <ul class="mb-0 ps-3">
                        <li>Permissions apply to <strong>all users</strong> with that role.</li>
                        <li>When a module is disabled, navigation links hide and access is denied.</li>
                        <li>Admin role has full access to all modules by default.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Role Pills for quick switching -->
        <ul class="nav nav-pills mb-4 flex-nowrap overflow-auto pb-2" id="rolePermTabs" role="tablist">
            {% for role, perm_form in role_forms.items %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if forloop.first %}active{% endif %} d-flex align-items-center gap-2 text-nowrap"
                        id="role-{{ perm_form.instance.role }}-tab"
                        data-bs-toggle="pill"
                        data-bs-target="#role-{{ perm_form.instance.role }}-panel"
                        type="button"
                        role="tab"
                        aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                    {{ perm_form.instance.get_role_display }}
                    {% if perm_form.instance.role == 'admin' %}
                        <span class="badge bg-primary">Full</span>
                    {% endif %}
                </button>
            </li>
            {% endfor %}
        </ul>

        <div class="tab-content" id="rolePermTabContent">
            {% for role, perm_form in role_forms.items %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                 id="role-{{ perm_form.instance.role }}-panel"
                 role="tabpanel"
                 aria-labelledby="role-{{ perm_form.instance.role }}-tab">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold">{{ perm_form.instance.get_role_display }} Permissions</div>
                            <small class="text-muted">{{ perm_form.fields|length }} modules available</small>
                        </div>
                        {% if perm_form.instance.role == 'admin' %}
                            <span class="badge bg-primary">All access by default</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <form method="post" class="role-perm-form">
                            {% csrf_token %}
                            <input type="hidden" name="perm_role" value="{{ perm_form.instance.role }}">
                            <div class="row g-3">
                                {% for field in perm_form %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-check form-switch p-3 border rounded h-100 d-flex align-items-center justify-content-between bg-light">
                                        <label class="form-check-label fw-medium" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ field|add_class:"form-check-input" }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="mt-4 pt-3 border-top">
                                <button class="btn btn-primary">Save {{ perm_form.instance.get_role_display }} Permissions</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // User search functionality
    const searchInput = document.getElementById('userSearch');
    const tableRows = document.querySelectorAll('#usersTable tbody tr[data-search]');

    if (searchInput && tableRows.length) {
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            tableRows.forEach(row => {
                const text = (row.dataset.search || '').toLowerCase();
                row.style.display = !query || text.includes(query) ? '' : 'none';
            });
        });
    }

    // Auto-switch to form tab if editing
    {% if editing %}
    const formTab = document.getElementById('form-tab');
    if (formTab) {
        const tab = new bootstrap.Tab(formTab);
        tab.show();
    }
    {% endif %}

    // Auto-switch to form tab if there are form errors
    {% if form.errors %}
    const formTab = document.getElementById('form-tab');
    if (formTab) {
        const tab = new bootstrap.Tab(formTab);
        tab.show();
    }
    {% endif %}
});
</script>
{% endblock %}
